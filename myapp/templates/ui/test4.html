<!DOCTYPE html>
<html>
<head>
  <title>Graph</title>
  <!-- Include the Chart.js library -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div id="filters">
    <!-- <label for="districtFilter">District:</label>
    <select id="districtFilter">
      <option value="">All Districts</option>
      <option value="Rwamagana">Rwamagana</option>
      <option value="Kicukiro">Kicukiro</option>
      <option value="Bugesera">Bugesera</option>
      <option value="Gakenke">Gakenke</option>
      <option value="Gasabo">Gasabo</option>
      <option value="Huye">Huye</option>
      <option value="Karongi">Karongi</option>
      <option value="Kayonza">Kayonza</option>
      <option value="Kirehe">Kirehe</option>
      <option value="Muhanga">Muhanga</option>
      <option value="Musanze">Musanze</option>
      <option value="Rubavu">Rubavu</option>
      <option value="Nyarugenge">Nyarugenge</option>
      <option value="Rusizi">Rusizi</option>
      <option value="Gatsibo">Gatsibo</option>
      <option value="Ngoma">Ngoma</option>
      <option value="Nyagatare">Nyagatare</option>
      <option value="Burera">Burera</option>
      <option value="Gicumbi">Gicumbi</option>
      <option value="Rulindo">Rulindo</option>
      <option value="Gisagara">Gisagara</option>
      <option value="Ngororero">Ngororero</option>
      <option value="Nyabihu">Nyabihu</option>
      <option value="Nyamasheke">Nyamasheke</option>
      <option value="Kamonyi">Kamonyi</option>
      <option value="Nyamagabe">Nyamagabe</option>
      <option value="Nyanza">Nyanza</option>
      <option value="Nyaruguru">Nyaruguru</option>
      <option value="Ruhango">Ruhango</option>
      <option value="Rutsiro">Rutsiro</option>
      
    </select> -->
    <label for="accountManagerFilter">Account Manager:</label>
      <select id="accountManagerFilter" class="light-bg">
        <!-- Options for Account Manager -->
        <option value="">All</option>
        <option value="MUKAMANA">MUKAMANA</option>
        <option value="KIZZA">KIZZA</option>
        <option value="MUSONI">MUSONI</option>
        <option value="BANZA">BANZA</option>
        <option value="GAHIGI">GAHIGI</option>
        <option value="MUKANOHERI">MUKANOHERI</option>
        <option value="NIYITEGEKA">NIYITEGEKA</option>
        <option value="MUGISHA">MUGISHA</option>
      </select>


    <label for="productFilter">Product:</label>
      <select id="productFilter" class="light-bg">
        <!-- Options for Product -->
        <option value="">All</option>
        <option value="4G LTE connectivity">4G LTE connectivity</option>
        <option value="Fiber Broadband Internet - Private">Fiber Broadband Internet - Private</option>
        <option value="Fiber Broadband Internet - GoR">Fiber Broadband Internet - GoR</option>
        <option value="Cloud Computing">Cloud Computing</option>
        <option value="Projects">Projects</option>
        <option value="Dark Fiber Lease">Dark Fiber Lease</option>
        <option value="VOIP">VOIP</option>
        <option value="Managed Security Services">Managed Security Services</option>
        <option value="Video Conferencing Services">Video Conferencing Services</option>
        <option value="Local Content">Local Content</option>
      </select>
  </div>
  <!-- <canvas id="Chart4" style="width: 100%; height: 420px"></canvas> -->
  <canvas id="salesTargetsChart" width="400" height="100"></canvas>
  <script>
    // Fetch the JSON data from Django template variables
    var reportData = JSON.parse('{{ report_data|escapejs }}');
    var targetData = JSON.parse('{{ target_data|escapejs }}');
    console.log(targetData);
    console.log(reportData);
  
    // Function to calculate the total sales and total targets for each month
    function calculateTotalsByMonth(data) {
      const totalsByMonth = {};
      data.forEach((item) => {
        const { total_sales, total_targets, sales_month } = item;
        if (totalsByMonth[sales_month]) {
          totalsByMonth[sales_month].total_sales += parseFloat(total_sales);
          totalsByMonth[sales_month].total_targets += parseFloat(total_targets);
        } else {
          totalsByMonth[sales_month] = {
            total_sales: parseFloat(total_sales),
            total_targets: parseFloat(total_targets),
          };
        }
      });
      return totalsByMonth;      
    }

    // Process the JSON data to get total sales and total targets by month
    const salesTotalsByMonth = calculateTotalsByMonth(reportData);
    const targetsTotalsByMonth = calculateTotalsByMonth(targetData);
  
    // Prepare data for the chart
    const months2 = Object.keys(salesTotalsByMonth);
    const months = Object.keys(targetsTotalsByMonth);
    const salesData = months2.map((month) => salesTotalsByMonth[month].total_sales);
    const targetsData = months.map((month) => targetsTotalsByMonth[month].total_targets);
  
  
    // Create the initial chart
    const ctx = document.getElementById("salesTargetsChart").getContext("2d");
    const chart = new Chart(ctx, {
      type: "bar",
      data: {
        labels: months,
        datasets: [
          {
            label: "Total Sales",
            backgroundColor: "#4A6CF7",
            data: salesData,
          },
          {
            label: "Total Targets",
            backgroundColor: "#d50100",
            data: targetsData,
          },
        ],
      },
      options: {
        // Add any additional options here if needed
        // For example, you can customize tooltips, axis labels, etc.
      },
    });
  
    // Event listeners for filter dropdowns
    //document.getElementById("districtFilter").addEventListener("change", updateChart);
    document.getElementById("accountManagerFilter").addEventListener("change", updateChart);
    document.getElementById("productFilter").addEventListener("change", updateChart);
  
    // Function to update the chart based on filters
    function updateChart() {
      // Get selected filter values profile Filter
      //const selectedDistrict = document.getElementById("districtFilter").value;
      const selectedAccount_manager = document.getElementById("accountManagerFilter").value;
      const selectedProduct = document.getElementById("productFilter").value;
  
      // Filter data based on selected filters
      const filteredReportData = reportData.filter(item =>
        //(!selectedDistrict || item.district === selectedDistrict) &&
        (!selectedAccount_manager|| item.account_manager === selectedAccount_manager) &&
        (!selectedProduct || item.product === selectedProduct)
      );

      // Filter data based on selected filters
      const filteredtargetData = targetData.filter(item =>
        //(!selectedDistrict || item.district === selectedDistrict) &&
        (!selectedAccount_manager|| item.account_manager === selectedAccount_manager) &&
        (!selectedProduct || item.product === selectedProduct)
      );
  
      // Recalculate totals and prepare data for the chart 
      const filteredSalesTotalsByMonth = calculateTotalsByMonth(filteredReportData);
      const filteredTargetsData = calculateTotalsByMonth(filteredtargetData);
      console.log(filteredSalesTotalsByMonth);
      console.log(filteredTargetsData);
      // Get filtered months from the sales data
      const filteredMonths = Object.keys(filteredSalesTotalsByMonth);
      const filteredMonths2 = Object.keys(filteredTargetsData);
  
      // Update the chart data and labels
      chart.data.labels = filteredMonths;
      chart.data.labels = filteredMonths2;
      chart.data.datasets[0].data = filteredMonths.map(month => filteredSalesTotalsByMonth[month].total_sales);
      chart.data.datasets[1].data = filteredMonths2.map(month => filteredTargetsData[month].total_targets);
  
      // Redraw the chart
      chart.update();
    }
  </script>
  
</body>
</html>
