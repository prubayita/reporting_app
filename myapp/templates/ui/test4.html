<!DOCTYPE html>
<html>
<head>
  <title>Graph</title>
  <!-- Include the Chart.js library -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div id="filters">
    <label for="accountManagerFilter">Account Manager:</label>
    <select id="accountManagerFilter" class="light-bg">
      <option value="">All</option>
      {% for account_manager in account_managers %}
        <option value="{{ account_manager }}">{{ account_manager }}</option>
      {% endfor %}
    </select>

    <label for="productFilter">Product:</label>
    <select id="productFilter" class="light-bg">
      <option value="">All</option>
      {% for product in products %}
        <option value="{{ product }}">{{ product }}</option>
      {% endfor %}
    </select>
  </div>

  <canvas id="salesTargetsChart" width="400" height="100"></canvas>
  <script>
    var reportData = JSON.parse('{{ report_data|escapejs }}');
    var targetData = JSON.parse('{{ target_data|escapejs }}');
    
    function calculateTotalsByMonth(data) {
      const totalsByMonth = {};
      data.forEach((item) => {
        const { total_sales, total_targets, sales_month } = item;
        if (!totalsByMonth[sales_month]) {
          totalsByMonth[sales_month] = { total_sales: 0, total_targets: 0 };
        }
        totalsByMonth[sales_month].total_sales += parseFloat(total_sales);
        totalsByMonth[sales_month].total_targets += parseFloat(total_targets);
      });
      return totalsByMonth;
    }

    const salesTotalsByMonth = calculateTotalsByMonth(reportData);
    const targetsTotalsByMonth = calculateTotalsByMonth(targetData);

    const months = Object.keys(targetsTotalsByMonth);
    const salesData = months.map((month) => salesTotalsByMonth[month]?.total_sales || 0);
    const targetsData = months.map((month) => targetsTotalsByMonth[month]?.total_targets || 0);

    const ctx = document.getElementById("salesTargetsChart").getContext("2d");
    const chart = new Chart(ctx, {
      type: "bar",
      data: {
        labels: months,
        datasets: [
          {
            label: "Total Sales",
            backgroundColor: "#4A6CF7",
            data: salesData,
          },
          {
            label: "Total Targets",
            backgroundColor: "#d50100",
            data: targetsData,
          },
        ],
      },
      options: {
        // Add any additional options here if needed
      },
    });

    document.getElementById("accountManagerFilter").addEventListener("change", updateChart);
    document.getElementById("productFilter").addEventListener("change", updateChart);

    function updateChart() {
      const selectedAccount_manager = document.getElementById("accountManagerFilter").value;
      const selectedProduct = document.getElementById("productFilter").value;

      const filteredReportData = reportData.filter(item =>
        (!selectedAccount_manager || item.account_manager === selectedAccount_manager) &&
        (!selectedProduct || item.product === selectedProduct)
      );

      const filteredtargetData = targetData.filter(item =>
        (!selectedAccount_manager || item.account_manager === selectedAccount_manager) &&
        (!selectedProduct || item.product === selectedProduct)
      );

      const filteredSalesTotalsByMonth = calculateTotalsByMonth(filteredReportData);
      const filteredTargetsData = calculateTotalsByMonth(filteredtargetData);

      const filteredMonths = Object.keys(filteredSalesTotalsByMonth);

      chart.data.labels = filteredMonths;
      chart.data.datasets[0].data = filteredMonths.map(month => filteredSalesTotalsByMonth[month]?.total_sales || 0);
      chart.data.datasets[1].data = filteredMonths.map(month => filteredTargetsData[month]?.total_targets || 0);

      chart.update();
    }
  </script>
</body>
</html>
