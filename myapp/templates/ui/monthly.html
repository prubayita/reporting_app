
{% extends "base.html" %}

{% load static %}
{% block content %}
   <style>
    .main-btn2 {
  display: inline-block;
  text-align: center;
  white-space: nowrap;
  vertical-align: middle;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
  padding: 15px 15px;
  font-weight: 500;
  font-size: 14px;
  line-height: 4px;
  border-radius: 64px;
  cursor: pointer;
  z-index: 5;
  transition: all 0.4s ease-in-out;
  border: 1px solid transparent;
  overflow: hidden;
  margin: 5px
}
    .pagination-buttons-container {
  display: flex;
  justify-content: center;
  position: fixed;
  bottom: 20px; /* Adjust this value to set the desired distance from the bottom */
  left: 0;
  right: 0;
  z-index: 999; /* Ensure the buttons appear above other elements */
}
#map {
  height: 500px;
 }
.select-style-1 .select-position.select-sm::after {
    margin-top: 8px;
  }
   </style>
    <!-- ======== sidebar-nav end =========== -->

    <!-- ======== main-wrapper start =========== -->
    
      <!-- ========== header start ========== -->

      <!-- ========== header end ========== -->

      <!-- ========== section start ========== -->
      <section class="section">
        <div class="container-fluid">
          <!-- ========== title-wrapper start ========== -->
          <div class="title-wrapper pt-30">
            <div class="row align-items-center">
              <div class="col-md-6">
                <div class="title mb-30">
                  <h2>Monthly Dashboard</h2>
                  <a href="{% url 'monthly' %}"><button type="submit" class="center main-btn primary-btn btn-hover">Acc Manager</button></a>
                  <a href="{% url 'monthly2' %}"><button type="submit" class="main-btn primary-btn btn-hover">Product</button></a>                                    
                </div>
              </div>
              <!-- end col -->
              <div class="col-md-6">
                <div class="breadcrumb-wrapper mb-30">
                  <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                      <li class="breadcrumb-item">
                        <a href="#0">Dashboard</a>
                      </li>
                      <li class="breadcrumb-item active" aria-current="page">
                        Monthly
                      </li>
                    </ol>
                  </nav>
                </div>
              </div>
              <!-- end col -->
            </div>
            <!-- end row -->
          </div>
          <!-- ========== title-wrapper end ========== -->
          <div class="row visually-hidden">
            <div class="col-xl-3 col-lg-4 col-sm-6">
              <div class="icon-card mb-30">
                <div class="icon success">
                  <i class="lni lni-dollar"></i>
                </div>
                <div class="content">
                  <h6 class="mb-10">Total Income</h6>
                  <h3 class="text-bold mb-10" id="total-sales"></h3>
                  <p class="text-sm text-success" id="percentage-difference">
                   
                  </p>
                </div>
              </div>
              <!-- End Icon Cart -->
            </div>
            <!-- End Col -->
            <div class="col-xl-3 col-lg-4 col-sm-6">
              <div class="icon-card mb-30">
                <div class="icon primary">
                  <i class="lni lni-credit-cards"></i>
                </div>
                <div class="content">
                  <h6 class="mb-10">Total Target</h6>
                  <h3 class="text-bold mb-10" id="total-targets"></h3>
                </div>
              </div>
              <!-- End Icon Cart -->
            </div>
            <!-- End Col -->
          </div>
          <!-- End Row -->

          <!-- FILTERS -->
          <div class="row" id="targetDiv">
            <div class="col-lg-12">
              <div class="card-style mb-30">
                <!-- Use "d-flex" to create a flex container and "flex-wrap" to wrap the items to the next line if necessary. -->
                <div class="d-flex flex-wrap align-items-center justify-content-between">
                  <!-- "mb-2" adds margin-bottom to create spacing between the filters. -->
                  <div class="select-style-1 mb-2">
                    <div class="select-position select-sm">
                      <label for="sales-month-filter2">Sales Month:</label>
                      <!-- The "light-bg" class is used for styling purposes. -->
                      <select id="sales-month-filter2" class="light-bg">
                        <!-- Options for Sales Month -->
                        <option value="">All</option>
                        <option value="January">January</option>
                        <option value="February">February</option>
                        <option value="March">March</option>
                        <option value="April">April</option>
                        <option value="May">May</option>
                        <option value="June">June</option>
                        <option value="July">July</option>
                        <option value="August">August</option>
                        <option value="September">September</option>
                        <option value="October">October</option>
                        <option value="November">November</option>
                        <option value="December">December</option>
                      </select>
                    </div>
                  </div>
          
                  <!-- Repeat the same structure for other filters. -->
     
                  
                </div>
              </div>
            </div>
          </div>

          <!--all sales-->
          <div class="row">
            <div class="col-lg-12">
           <div class="card-style mb-30">
             <div
               class="
                 title
                 d-flex
                 flex-wrap
                 align-items-center
                 justify-content-between
               "
             >
               <div class="left">
                 <h6 class="text-medium mb-30">Product performance</h6>
               </div>
               
             </div>
             <!-- End Title -->
             <div class="table-responsive">
               
                <table id="product-account-manager-table" class="table top-selling-table">
                    <thead>
                      <tr>
                        <th>
                          <h6 class="text-sm text-medium">Products</h6>
                        </th>
                      
                        <th>
                          <h6 class="text-sm text-medium">MUKAMANA</h6>
                        </th>
                        <th>
                            <h6 class="text-sm text-medium">KIZZA</h6>
                          </th>
                          <th>
                            <h6 class="text-sm text-medium">MUSONI</h6>
                          </th>
                          <th>
                            <h6 class="text-sm text-medium">MUKANOHERI</h6>
                          </th>
                          <th>
                            <h6 class="text-sm text-medium">BANZA</h6>
                          </th>
                          <th>
                            <h6 class="text-sm text-medium">MUGISHA</h6>
                          </th>
                          <th>
                            <h6 class="text-sm text-medium">NIYITEGEKA</h6>
                          </th>
                          <th>
                            <h6 class="text-sm text-medium">GAHIGI</h6>
                          </th>
                          
                         
                        <th>
                          <h6 class="text-sm text-medium">Grand Total</h6>
                        </th>
                      </tr>
                    </thead>
                    <tbody>
                      <!-- table rows will be dynamically added using JavaScript -->
                    </tbody>
                  </table>
               <!-- End Table -->
             </div>
             <div class="visually-hidden">
             <canvas id="salesChart" width="400" height="200"></canvas>
             </div>

           </div>
         </div>
       </div>
          
        <!-- end container -->
      </section>
      <!-- ========== section end ========== -->

      <!-- ========== footer start =========== -->
      <footer class="footer">
        <div class="container-fluid">
          <div class="row">
            <div class="col-md-6 order-last order-md-first">
              <div class="copyright text-center text-md-start">
                <p class="text-sm">
                  Designed and Developed by
                  <a
                    href="https://bsc.rw"
                    rel="nofollow"
                    target="_blank"
                  >
                    BSC Ltd.
                  </a>
                </p>
              </div>
            </div>
            <!-- end col-->
            <div class="col-md-6">
              <div
                class="
                  terms
                  d-flex
                  justify-content-center justify-content-md-end
                "
              >
                <a href="#0" class="text-sm">Term & Conditions</a>
                <a href="#0" class="text-sm ml-15">Privacy & Policy</a>
              </div>
            </div>
          </div>
          <!-- end row -->
        </div>
        <!-- end container -->
      </footer>
      <!-- ========== footer end =========== -->
    </main>
    <!-- ======== main-wrapper end =========== -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        $(document).ready(function() {
        // Hide the div initially (optional)
        $('#targetDiv').hide();
    
        // Add click event listener to the button
        $('#toggleButton').on('click', function() {
        // Toggle the visibility of the div
        $('#targetDiv').toggle();
        });
        });
    </script>
    
  
    <script>
      var allData = JSON.parse('{{ report_data|escapejs }}');
      var allTarget = JSON.parse('{{ target_data|escapejs }}');
      console.log(allTarget);
      // Hard-coded account manager names
var accountManagers = ["MUKAMANA", "KIZZA", "MUSONI", "MUKANOHERI", "BANZA", "MUGISHA", "NIYITEGEKA", "GAHIGI"];

// Function to get actual sales data for the specified account manager
function getActualSales(accountManagerName, selectedMonth) {
  // Filter the data by account manager name and optional selected month
  var filteredData = allData.filter(function(item) {
    return item.account_manager.trim() === accountManagerName &&
      (!selectedMonth || item.sales_month.trim() === selectedMonth);
  });

  // Calculate the total sales for each month
  var salesByMonth = {};
  filteredData.forEach(function(item) {
    var month = item.sales_month.trim();
    if (!salesByMonth[month]) {
      salesByMonth[month] = 0;
    }
    salesByMonth[month] += item.qty * item.price;
  });

  // Convert the sales data to an array
  var salesArray = Object.values(salesByMonth);

  return salesArray;
}

// Function to get actual target data for the specified account manager
function getActualTargets(accountManagerName, selectedMonth) {
  // Filter the data by account manager name and optional selected month
  var filteredTargets = allTarget.filter(function(targetItem) {
    return targetItem.account_manager.trim() === accountManagerName &&
      (!selectedMonth || targetItem.sales_month.trim() === selectedMonth);
  });

  // Extract the total targets for each target item
  var targetArray = filteredTargets.map(function(targetItem) {
    return targetItem.total_targets;
  });

  return targetArray;
}

      // Function to get unique account manager names from the data
      function getUniqueAccountManagers(data) {
        const uniqueAccountManagers = new Set();
        data.forEach(function (item) {
          uniqueAccountManagers.add(item.account_manager.trim());
        });
        return Array.from(uniqueAccountManagers);
      }
    
      // Function to populate the "Sales by Product and Account Manager-Monthly Dashboard" table
      function populateProductAccountManagerTable(data, accountManagers, selectedMonth) {
        var tableBody = $('#product-account-manager-table tbody');
        tableBody.empty();
    
        var products = new Set(data.map(item => item.product));
    
        var accountManagerTotals = {}; // Object to store the total sales for each account manager
        var accountManagerTargets = {}; // Object to store the total targets for each account manager
    
        products.forEach(function (product) {
          var row = $('<tr>');
          row.append($('<td>').text(product));
    
          accountManagers.forEach(function (accountManagerName) {
            var totalSales = 0;
            var totalTargets = 0; // Variable to store the total targets for each account manager
    
            // Filter data by selected month (if applicable) and accountManager
            data.forEach(function (item) {
              if (item.product === product && item.account_manager.trim() === accountManagerName && (!selectedMonth || item.sales_month.trim() === selectedMonth)) {
                totalSales += item.qty * item.price;
              }
            });
    
            row.append($('<td>').text(totalSales));
    
            // Update the total sales for the account manager
            if (!accountManagerTotals[accountManagerName]) {
              accountManagerTotals[accountManagerName] = totalSales;
            } else {
              accountManagerTotals[accountManagerName] += totalSales;
            }
    
            // Calculate the total targets for the account manager (if applicable)
            var target = allTarget.find(
              targetItem =>
                targetItem.account_manager.trim() === accountManagerName &&
                targetItem.product === product &&
                targetItem.sales_month.trim() === selectedMonth
            );
            if (target) {
              totalTargets = target.total_targets;
            }
    
            // Update the total targets for the account manager
            if (!accountManagerTargets[accountManagerName]) {
              accountManagerTargets[accountManagerName] = totalTargets;
            } else {
              accountManagerTargets[accountManagerName] += totalTargets;
            }
          });
    
          // Calculate the grand total for each product and account manager
          var grandTotal = 0;
          data.forEach(function (item) {
            if (item.product === product && (!selectedMonth || item.sales_month.trim() === selectedMonth)) {
              grandTotal += item.qty * item.price;
            }
          });
          row.append($('<td>').text(grandTotal));
    
          tableBody.append(row);
        });
    
        // Add a row to show the total sales for each account manager
        var totalRow = $('<tr>');
        totalRow.append($('<td>').html('<strong>Total Sales</strong>'));
        accountManagers.forEach(function (accountManagerName) {
          var totalSales = accountManagerTotals[accountManagerName] || 0;
          totalRow.append($('<td>').html('<strong>' + totalSales + '</strong>'));
        });
        totalRow.append('<td></td>'); // Empty cell for the grand total column
        tableBody.append(totalRow);
    
        // Add a row to show the total targets for each account manager
        var targetRow = $('<tr>');
        targetRow.append($('<td>').html('<strong>Total Targets</strong>'));
        accountManagers.forEach(function (accountManagerName) {
          var totalTargets = accountManagerTargets[accountManagerName] || 0;
          targetRow.append($('<td>').html('<strong>' + totalTargets + '</strong>'));
        });
        targetRow.append('<td></td>'); // Empty cell for the grand total column
        tableBody.append(targetRow);
        // Add a row to show the percentage achieved for each account manager
        var percentageAchievedRow = $('<tr>');
          percentageAchievedRow.append($('<td>').html('<strong>Percentage Achieved</strong>'));
          accountManagers.forEach(function (accountManagerName) {
            var totalSales = accountManagerTotals[accountManagerName] || 0;
            var totalTargets = accountManagerTargets[accountManagerName] || 0;
            var percentageAchieved = totalTargets !== 0 ? (totalSales / totalTargets) * 100 : 0;
            percentageAchievedRow.append($('<td>').html('<strong>' + percentageAchieved.toFixed(2) + '%</strong>'));
          });
          percentageAchievedRow.append('<td></td>'); // Empty cell for grand total column
          tableBody.append(percentageAchievedRow);
      }
    
      // Call the function to get unique account managers
      var accountManagers = getUniqueAccountManagers(allData);
      console.log(accountManagers);
    
      // Populate the "Sales by Product and Account Manager" table with the dynamic account managers
      populateProductAccountManagerTable(allData, accountManagers, '');
    
      // Add event listener to the "Sales Month" filter dropdown

// Update the actual sales and target data using Django template tags
var actualSales = {{ report_data|safe }};
var actualTargets = {{ target_data|safe }};
console.log(JSON.stringify(actualSales, null, 2));
// Initialize and configure the chart
var ctx = document.getElementById('salesChart').getContext('2d');
var chart = new Chart(ctx, {
  type: 'bar',
  data: {
    labels: accountManagers,
    datasets: [
      {
        label: 'Actual Sales',
        data: actualSales,
        backgroundColor: 'rgba(75, 192, 192, 0.6)', // Adjust the color as needed
      },
      {
        label: 'Actual Targets',
        data: actualTargets,
        backgroundColor: 'rgba(255, 99, 132, 0.6)', // Adjust the color as needed
      },
    ],
  },
  options: {
    scales: {
      x: {
        type: 'category', // Use 'category' type for the X-axis
        stacked: true,
      },
      y: {
        beginAtZero: true,
        stacked: true,
      },
    },
  },
});

// Render the chart
chart.update();
$('#sales-month-filter2').on('change', function() {
  var selectedMonth = this.value.trim(); // Update the selected month value when the user selects a new option
  populateProductAccountManagerTable(allData, accountManagers, selectedMonth); // Repopulate the table with the filtered data

  // Update the chart data based on the selected month
  accountManagers.forEach(function(accountManagerName, index) {
    var actualSalesData = getActualSales(accountManagerName, selectedMonth);
    var actualTargetsData = getActualTargets(accountManagerName, selectedMonth);

    // Update the chart dataset with the new data
    chart.data.datasets[index].data = actualSalesData;
    chart.data.datasets[index + accountManagers.length].data = actualTargetsData;
  });

  // Update the chart
  chart.update();
});
    </script>
    
    
{% endblock content %}
